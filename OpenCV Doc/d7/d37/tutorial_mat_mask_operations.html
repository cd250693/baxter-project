<!-- HTML header for doxygen 1.8.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>OpenCV: Mask operations on matrices</title>
<link href="../../opencv.ico" rel="shortcut icon" type="image/x-icon" />
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
MathJax.Hub.Config(
{
  TeX: {
      Macros: {
          matTT: [ "\\[ \\left|\\begin{array}{ccc} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{array}\\right| \\]", 9],
          fork: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ \\end{array} \\right.", 4],
          forkthree: ["\\left\\{ \\begin{array}{l l} #1 & \\mbox{#2}\\\\ #3 & \\mbox{#4}\\\\ #5 & \\mbox{#6}\\\\ \\end{array} \\right.", 6],
          vecthree: ["\\begin{bmatrix} #1\\\\ #2\\\\ #3 \\end{bmatrix}", 3],
          vecthreethree: ["\\begin{bmatrix} #1 & #2 & #3\\\\ #4 & #5 & #6\\\\ #7 & #8 & #9 \\end{bmatrix}", 9],
          hdotsfor: ["\\dots", 1],
          mathbbm: ["\\mathbb{#1}", 1],
          bordermatrix: ["\\matrix{#1}", 1]
      }
  }
}
);
</script><script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../opencv-logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenCV
   &#160;<span id="projectnumber">3.0.0</span>
   </div>
   <div id="projectbrief">Open Source Computer Vision</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li><a href="../..//3.0-last-rst"><span>Sphinx&#160;Documentation</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(13)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../d9/df8/tutorial_root.html">OpenCV Tutorials</a></li><li class="navelem"><a class="el" href="../../de/d7a/tutorial_table_of_content_core.html">The Core Functionality (core module)</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Mask operations on matrices </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Mask operations on matrices are quite simple. The idea is that we recalculate each pixels value in an image according to a mask matrix (also known as kernel). This mask holds values that will adjust how much influence neighboring pixels (and the current pixel) have on the new pixel value. From a mathematical point of view we make a weighted average, with our specified values.</p>
<h2>Our test case </h2>
<p>Let us consider the issue of an image contrast enhancement method. Basically we want to apply for every pixel of the image the following formula:</p>
<p class="formulaDsp">
\[I(i,j) = 5*I(i,j) - [ I(i-1,j) + I(i+1,j) + I(i,j-1) + I(i,j+1)]\]
</p>
 <p class="formulaDsp">
\[\iff I(i,j)*M, \text{where } M = \bordermatrix{ _i\backslash ^j &amp; -1 &amp; 0 &amp; +1 \cr -1 &amp; 0 &amp; -1 &amp; 0 \cr 0 &amp; -1 &amp; 5 &amp; -1 \cr +1 &amp; 0 &amp; -1 &amp; 0 \cr }\]
</p>
<p>The first notation is by using a formula, while the second is a compacted version of the first by using a mask. You use the mask by putting the center of the mask matrix (in the upper case noted by the zero-zero index) on the pixel you want to calculate and sum up the pixel values multiplied with the overlapped matrix values. It's the same thing, however in case of large matrices the latter notation is a lot easier to look over.</p>
<p>Now let us see how we can make this happen by using the basic pixel access method or by using the <a class="el" href="../../d4/d86/group__imgproc__filter.html#ga27c049795ce870216ddfb366086b5a04">cv::filter2D</a> function.</p>
<h2>The Basic Method </h2>
<p>Here's a function that will do this: </p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Sharpen(<span class="keyword">const</span> Mat&amp; myImage, Mat&amp; Result)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="../../db/de0/group__core__utils.html#gaf62bcd90f70e275191ab95136d85906b">CV_Assert</a>(myImage.depth() == <a class="code" href="../../dc/dcc/cvdef_8h.html#a32b18d904ee2b1731a9416a8eef67d06">CV_8U</a>);  <span class="comment">// accept only uchar images</span></div>
<div class="line"></div>
<div class="line">    Result.create(myImage.size(), myImage.type());</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> nChannels = myImage.channels();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 1; j &lt; myImage.rows - 1; ++j)</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* previous = myImage.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j - 1);</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* current  = myImage.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j    );</div>
<div class="line">        <span class="keyword">const</span> <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* next     = myImage.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j + 1);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* output = Result.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = nChannels; i &lt; nChannels * (myImage.cols - 1); ++i)</div>
<div class="line">        {</div>
<div class="line">            *output++ = <a class="code" href="../../df/dfc/group__cudev.html#ga27914f3dc7cee0a11ad7c6e5ad15edf7">saturate_cast</a>&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(5 * current[i]</div>
<div class="line">                         -current[i - nChannels] - current[i + nChannels] - previous[i] - next[i]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    Result.row(0).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0));</div>
<div class="line">    Result.row(Result.rows - 1).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0));</div>
<div class="line">    Result.col(0).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0));</div>
<div class="line">    Result.col(Result.cols - 1).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0));</div>
<div class="line">}</div>
</div><!-- fragment --><p> At first we make sure that the input images data is in unsigned char format. For this we use the <a class="el" href="../../db/de0/group__core__utils.html#gaf62bcd90f70e275191ab95136d85906b">cv::CV_Assert</a> function that throws an error when the expression inside it is false. </p>
<div class="fragment"><div class="line"><a class="code" href="../../db/de0/group__core__utils.html#gaf62bcd90f70e275191ab95136d85906b">CV_Assert</a>(myImage.depth() == <a class="code" href="../../dc/dcc/cvdef_8h.html#a32b18d904ee2b1731a9416a8eef67d06">CV_8U</a>);  <span class="comment">// accept only uchar images</span></div>
</div><!-- fragment --><p> We create an output image with the same size and the same type as our input. As you can see in the <a class="el" href="../../db/da5/tutorial_how_to_scan_images.html#tutorial_how_to_scan_images_storing">storing</a> section, depending on the number of channels we may have one or more subcolumns. We will iterate through them via pointers so the total number of elements depends from this number. </p>
<div class="fragment"><div class="line">Result.create(myImage.size(), myImage.type());</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> nChannels = myImage.channels();</div>
</div><!-- fragment --><p> We'll use the plain C [] operator to access pixels. Because we need to access multiple rows at the same time we'll acquire the pointers for each of them (a previous, a current and a next line). We need another pointer to where we're going to save the calculation. Then simply access the right items with the [] operator. For moving the output pointer ahead we simply increase this (with one byte) after each operation: </p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 1; j &lt; myImage.rows - 1; ++j)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* previous = myImage.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j - 1);</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* current  = myImage.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j    );</div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* next     = myImage.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j + 1);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>* output = Result.ptr&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(j);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = nChannels; i &lt; nChannels * (myImage.cols - 1); ++i)</div>
<div class="line">    {</div>
<div class="line">        *output++ = <a class="code" href="../../df/dfc/group__cudev.html#ga27914f3dc7cee0a11ad7c6e5ad15edf7">saturate_cast</a>&lt;<a class="code" href="../../d5/d64/defs_8h.html#a65f85814a8290f9797005d3b28e7e5fc">uchar</a>&gt;(5 * current[i]</div>
<div class="line">                     -current[i - nChannels] - current[i + nChannels] - previous[i] - next[i]);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> On the borders of the image the upper notation results inexistent pixel locations (like minus one - minus one). In these points our formula is undefined. A simple solution is to not apply the kernel in these points and, for example, set the pixels on the borders to zeros: </p>
<div class="fragment"><div class="line">Result.row(0).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0));               <span class="comment">// The top row</span></div>
<div class="line">Result.row(Result.rows - 1).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0)); <span class="comment">// The bottom row</span></div>
<div class="line">Result.col(0).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0));               <span class="comment">// The left column</span></div>
<div class="line">Result.col(Result.cols - 1).setTo(<a class="code" href="../../dc/d84/group__core__basic.html#ga599fe92e910c027be274233eccad7beb">Scalar</a>(0)); <span class="comment">// The right column</span></div>
</div><!-- fragment --><h2>The filter2D function </h2>
<p>Applying such filters are so common in image processing that in OpenCV there exist a function that will take care of applying the mask (also called a kernel in some places). For this you first need to define a <em>Mat</em> object that holds the mask: </p>
<div class="fragment"><div class="line">Mat kern = (Mat_&lt;char&gt;(3,3) &lt;&lt;  0, -1,  0,</div>
<div class="line">                               -1,  5, -1,</div>
<div class="line">                                0, -1,  0);</div>
</div><!-- fragment --><p> Then call the <a class="el" href="../../d4/d86/group__imgproc__filter.html#ga27c049795ce870216ddfb366086b5a04">cv::filter2D</a> function specifying the input, the output image and the kernell to use: </p>
<div class="fragment"><div class="line"><a class="code" href="../../d4/d86/group__imgproc__filter.html#ga27c049795ce870216ddfb366086b5a04">filter2D</a>(I, K, I.depth(), kern);</div>
</div><!-- fragment --><p> The function even has a fifth optional argument to specify the center of the kernel, and a sixth one for determining what to do in the regions where the operation is undefined (borders). Using this function has the advantage that it's shorter, less verbose and because there are some optimization techniques implemented it is usually faster than the <em>hand-coded method</em>. For example in my test while the second one took only 13 milliseconds the first took around 31 milliseconds. Quite some difference.</p>
<p>For example:</p>
<div class="image">
<img src="../../resultMatMaskFilter2D.png" alt="resultMatMaskFilter2D.png"/>
</div>
<p>You can download this source code from <a href="https://github.com/Itseez/opencv/tree/master/samples/cpp/tutorial_code/core/mat_mask_operations/mat_mask_operations.cpp">here</a> or look in the OpenCV source code libraries sample directory at <code>samples/cpp/tutorial_code/core/mat_mask_operations/mat_mask_operations.cpp</code>.</p>
<p>Check out an instance of running the program on our <a href="http://www.youtube.com/watch?v=7PF1tAU9se4">YouTube channel</a> .</p>
 
<div align="center">
<iframe width="560" height="349" src="https://www.youtube.com/embed/7PF1tAU9se4?hd=1" frameborder="0" allowfullscreen></iframe>
</div>
 </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Jun 20 2015 13:08:38 for OpenCV by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.6
</small></address>
</body>
</html>
